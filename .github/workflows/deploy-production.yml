name: Deploy to Production

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true
        default: 'latest'

jobs:
  version-check:
    name: Version Validation
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: get-version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION=${{ github.event.inputs.version }}
          else
            VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\///')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  build-and-push:
    name: Build and Push Production Images
    needs: version-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push production image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/economic-data-pipeline:latest
            ${{ secrets.DOCKER_USERNAME }}/economic-data-pipeline:${{ needs.version-check.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/economic-data-pipeline:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create deployment package
        run: |
          mkdir -p deployment
          cp docker-compose.yml deployment/
          cp .env.example deployment/
          tar -czf deployment-package.tar.gz deployment/

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package.tar.gz

  deploy-production:
    name: Deploy to Production
    needs: [version-check, build-and-push]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: Extract deployment package
        run: tar -xzf deployment-package.tar.gz

      - name: Deploy to production
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY_PRODUCTION }}
          PRODUCTION_HOST: ${{ secrets.PRODUCTION_HOST }}
          VERSION: ${{ needs.version-check.outputs.version }}
        run: |
          echo "$DEPLOY_KEY" > deploy_key
          chmod 600 deploy_key
          
          # Create backup tag before deployment
          ssh -i deploy_key -o StrictHostKeyChecking=no $PRODUCTION_HOST "
            docker tag ${{ secrets.DOCKER_USERNAME }}/economic-data-pipeline:latest ${{ secrets.DOCKER_USERNAME }}/economic-data-pipeline:backup-\$(date +%Y%m%d-%H%M%S) || true
          "
          
          # Upload new compose file
          scp -i deploy_key -o StrictHostKeyChecking=no deployment/docker-compose.yml $PRODUCTION_HOST:/opt/malaysia-data-pipeline/
          
          # Deploy with rollback capability
          ssh -i deploy_key -o StrictHostKeyChecking=no $PRODUCTION_HOST << 'EOF'
            cd /opt/malaysia-data-pipeline
            docker compose pull
            docker compose up -d
            
            # Wait for deployment
            sleep 30
            
            # Run health check
            if ! curl -f http://localhost:8501/health; then
              echo "Health check failed! Rolling back..."
              docker compose down
              docker compose up -d --use-old-images
              exit 1
            fi
          EOF

  health-check:
    name: Post-Deployment Health Check
    needs: deploy-production
    runs-on: ubuntu-latest
    steps:
      - name: Run health checks
        env:
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
        run: |
          echo "Running post-deployment health checks..."
          
          # Health endpoint check
          curl -f https://$PRODUCTION_URL/health || exit 1
          
          # Dashboard accessibility
          curl -f https://$PRODUCTION_URL || exit 1
          
          echo "All health checks passed!"

      - name: Notify success
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: 'Production deployment successful! Version: ${{ needs.version-check.outputs.version }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: 'Production deployment failed! Manual rollback may be needed.'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
